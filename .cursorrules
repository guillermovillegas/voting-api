# CONCURRENT AGENT DEVELOPMENT RULES
# ================================================================================
# ROLE: Repository Guardian & Conflict Prevention System
# CONTEXT: Multiple AI agents working simultaneously on this codebase
# GOAL: Zero merge conflicts, clean commits, parallel development at scale
# ================================================================================

## 0. ğŸ« AGENT REGISTRATION (FIRST ACTION REQUIRED)

**On session start, you MUST:**
1. Declare your AGENT_ID (propose one based on assigned task)
2. Read `AGENT_MANIFEST.md` to understand module ownership
3. Read `LOCKS.md` to check active file locks
4. Read `TASKS.md` to claim your task

**Example First Message:**
```
I am AGENT_AUTH. Checking manifest... I own:
- packages/server/src/modules/auth/
- packages/client/src/features/auth/
No lock conflicts detected. Claiming task T001.
```

---

## 1. ğŸ›‘ "STOP & LOOK" PROTOCOL (ENHANCED)

### 1.1 Branch Protection
Before generating ANY code:

| Branch | Action |
|--------|--------|
| `main`, `master`, `production` | ğŸ›‘ REFUSE. Message: "Create branch `agent/<id>/<feature>` first" |
| `dev`, `staging` | âš ï¸ WARN. Suggest feature branch |
| `agent/*` | âœ… Proceed if matches your AGENT_ID |

### 1.2 Collision Detection ("The Radar")
```bash
# Run silently before any file modification
git fetch origin --prune
git branch -r --sort=-committerdate | head -n 10
git log --oneline --since="2 hours ago" --all -- <files-you-plan-to-modify>
```

If another agent modified your target files in the last 2 hours:
- ğŸ›‘ STOP
- ğŸ’¬ "Potential collision: `<file>` was modified by `<branch>` at `<time>`. Coordinate or wait?"

### 1.3 Hot File Detection
These files are collision magnets. ALWAYS check before touching:
```
package.json          # Dependencies
*.lock               # Lock files (never modify directly)
prisma/schema.prisma # Database schema
*/index.ts           # Barrel exports
*/routes.ts          # Route registrations
*/App.tsx            # Main app component
```

---

## 2. ğŸ—ï¸ MODULE OWNERSHIP ENFORCEMENT

### 2.1 Ownership Check
Before creating/editing ANY file:
1. Determine module from path
2. Check ownership in `AGENT_MANIFEST.md`
3. If owned by another agent â†’ ğŸ›‘ REFUSE

### 2.2 Ownership Tiers

| Tier | Rules |
|------|-------|
| **EXCLUSIVE** | Only assigned agent can modify |
| **SHARED-APPEND** | Anyone can ADD new files, NEVER modify existing |
| **SHARED-COORDINATE** | Must claim lock in `LOCKS.md` first |
| **PROTECTED** | Requires explicit user confirmation per edit |

### 2.3 Path â†’ Module Mapping
```
packages/server/src/modules/auth/     â†’ AGENT_AUTH (EXCLUSIVE)
packages/server/src/modules/voting/   â†’ AGENT_VOTING (EXCLUSIVE)
packages/server/src/modules/teams/    â†’ AGENT_TEAMS (EXCLUSIVE)
packages/client/src/features/auth/    â†’ AGENT_AUTH (EXCLUSIVE)
packages/client/src/features/voting/  â†’ AGENT_VOTING (EXCLUSIVE)
packages/shared/types/                â†’ ALL (SHARED-APPEND)
packages/*/src/core/                  â†’ NONE (PROTECTED)
```

---

## 3. ğŸ” SOFT LOCK PROTOCOL

### 3.1 Before Editing Shared/Coordinate Files
1. **READ** `LOCKS.md`
2. **CHECK** if file is locked
3. **IF LOCKED** â†’ ğŸ›‘ Stop, notify user
4. **IF UNLOCKED** â†’ Add lock entry, then proceed

### 3.2 Lock Entry Format
```markdown
| File | Agent | Claimed | Expires | Purpose |
|------|-------|---------|---------|---------|
| stores/auth.ts | AGENT_AUTH | 2024-01-20T10:00Z | 2024-01-20T11:00Z | Add login state |
```

### 3.3 Lock Hygiene
- Lock expires after 1 hour (configurable)
- **ALWAYS** remove lock when task complete
- If you see expired locks, clean them up

---

## 4. ğŸ“ COMMIT PROTOCOL

### 4.1 Commit Message Format (STRICT)
```
[AGENT_ID][scope] type: description

Body (optional):
- What changed
- Why it changed
- Integration notes for other agents

Co-Authored-By: <agent-id>@ai-agent
```

### 4.2 Types
| Type | Use When |
|------|----------|
| `feat` | New feature |
| `fix` | Bug fix |
| `refactor` | Code restructure (no behavior change) |
| `chore` | Build, deps, config |
| `docs` | Documentation only |
| `test` | Adding/fixing tests |

### 4.3 Pre-Commit Checklist
```bash
# 1. Fetch latest
git fetch origin

# 2. Check for conflicts
git log --oneline origin/main..HEAD

# 3. Rebase if needed
git rebase origin/main

# 4. Verify types
npm run typecheck

# 5. Run affected tests
npm run test -- --filter=<your-module>
```

---

## 5. ğŸ›¡ï¸ PROTECTED FILE HANDLING

### 5.1 Protected File List
```
package.json
package-lock.json
tsconfig*.json
.env*
prisma/schema.prisma
docker-compose*.yml
.github/workflows/*
Dockerfile*
```

### 5.2 Protocol for Protected Files
1. ğŸ§  THINK: "Can I achieve this without modifying the protected file?"
2. ğŸ’¬ ASK: "This requires modifying `<protected-file>`. Confirm? (Y/n)"
3. ğŸ“‹ DIFF: Show ONLY the lines to change, not the entire file
4. â³ WAIT: Do not proceed without explicit "yes"

### 5.3 Dependency Changes (package.json)
- NEVER add dependencies without user approval
- ALWAYS specify exact versions, not ranges
- Check for existing alternatives first

---

## 6. ğŸ”„ CONFLICT RESOLUTION

### 6.1 When You See Conflict Markers
```
<<<<<<< HEAD
[code from HEAD]
=======
[code from branch]
>>>>>>> branch-name
```

**PROTOCOL:**
1. ğŸ›‘ Do NOT blindly pick one side
2. ğŸ” Analyze BOTH blocks semantically
3. ğŸ’¬ Explain: "HEAD adds X, branch adds Y"
4. ğŸ› ï¸ Propose merged version preserving BOTH intents
5. âš ï¸ Flag if intents conflict (needs user decision)

### 6.2 Proactive Conflict Avoidance
| Pattern | Instead Of |
|---------|------------|
| Create new file | Expand existing file |
| Add to end of array/list | Insert in middle |
| Use feature flags | Merge incomplete code |
| Export from new index | Modify shared index |

---

## 7. ğŸ¤ INTER-AGENT COMMUNICATION

### 7.1 Integration Points
When your feature needs another module:
1. **DEFINE** interface in `packages/shared/types/`
2. **MOCK** the dependency for your tests
3. **DOCUMENT** in `INTEGRATION.md`:
```markdown
## AGENT_AUTH needs from AGENT_VOTING
- `getCurrentVote(userId): Vote | null`
- Required by: 2024-01-21
```
4. **LET** the other agent implement when ready

### 7.2 Shared State
For Zustand/Redux stores or shared context:
1. Each agent owns their slice
2. Use `LOCKS.md` for cross-slice changes
3. Import from other slices, never modify them

---

## 8. ğŸ§ª TESTING REQUIREMENTS

### 8.1 Before Any Commit
```bash
npm run typecheck          # Must pass
npm run lint               # Must pass
npm run test:unit -- --filter=<module>  # Your module tests
```

### 8.2 Integration Tests
- Write tests in your module's `__tests__/` directory
- Mock external module dependencies
- Integration tests run in CI after PR

---

## 9. ğŸ“Š SESSION SUMMARY

**Before ending a session, output:**
```markdown
## Agent Session Summary: AGENT_ID

### Completed
- [list of commits with hashes]

### Files Modified
- [list with ownership tier]

### Integration Notes
- [anything other agents need to know]

### Locks Released
- [files you unlocked]

### Pending
- [work remaining for next session]
```

---

## 10. âš¡ QUICK DECISION TREE

```
Is file in my EXCLUSIVE module?
â”œâ”€ YES â†’ Proceed freely
â””â”€ NO â†’ Is it SHARED-APPEND?
         â”œâ”€ YES, adding new file â†’ Proceed
         â”œâ”€ YES, modifying existing â†’ ğŸ›‘ STOP
         â””â”€ NO â†’ Is it PROTECTED?
                  â”œâ”€ YES â†’ Ask user permission
                  â””â”€ NO (SHARED-COORDINATE) â†’ Check LOCKS.md
                           â”œâ”€ Locked â†’ ğŸ›‘ STOP, notify
                           â””â”€ Free â†’ Claim lock, proceed
```

---

## APPENDIX: Emergency Procedures

### Git Disaster Recovery
```bash
# Undo last commit (keep changes)
git reset --soft HEAD~1

# Abort merge in progress
git merge --abort

# Abort rebase in progress
git rebase --abort

# Stash work and start fresh
git stash push -m "emergency stash $(date)"
git checkout main
git pull origin main
```

### Stuck Agent Recovery
If an agent is stuck or abandoned mid-task:
1. Check `LOCKS.md` for their locks â†’ Release them
2. Check `TASKS.md` for their claims â†’ Unclaim
3. Check their branch for uncommitted work â†’ Stash or commit
